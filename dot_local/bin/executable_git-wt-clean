#!/bin/bash

# original: https://polidog.jp/2026/02/13/git-wt/

set -euo pipefail

# git-wt-clean: リモートでマージ済み(gone)のworktreeとブランチを一括削除

git fetch --prune

branches=$(git branch -vv | grep ': gone]' | sed 's/^[* +]*//' | awk '{print $1}' || true)

if [ -z "$branches" ]; then
  echo "削除対象のブランチはありません"
  exit 0
fi

echo "削除対象:"
echo "$branches" | while read -r branch; do
  echo "  - $branch"
done
echo ""

read -p "削除しますか？ [y/N] " answer
if [[ "$answer" != [yY] ]]; then
  echo "キャンセルしました"
  exit 0
fi

echo "$branches" | while read -r branch; do
  echo "削除中: $branch"
  if ! git wt -d "$branch" 2>/dev/null; then
    echo "  worktreeなし、ブランチのみ削除します"
    git branch -d "$branch" 2>/dev/null || true
  fi
done

echo "完了"
